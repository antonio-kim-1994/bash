#!/bin/bash
# Common Variable
# Basic Info
export USER_NAME=""
export USER_PASSWORD=""
export COMPANY_NAME=""
export BUCKET=""
export S3_ACC_KEY=""
export S3_SEC_KEY=""
export S3_URL=""

# CentOS
if grep ^NAME /etc/os-release | grep -q CentOS; then
  sudo yum install -y epel-release awscli
# Ubuntu
elif grep ^NAME /etc/os-release | grep -q Ubuntu; then
  sudo apt-get update > /dev/null 2>&1
  sudo apt-get install -y awscli > /dev/null 2>&1
fi
  mkdir -p ~/.aws
  echo "[default]
aws_access_key_id = $S3_ACC_KEY
aws_secret_access_key = $S3_SEC_KEY" > ~/.aws/credentials

  echo "[default]
region = FKR" > ~/.aws/config

# Download Scripts
## Upload Scripts
# aws s3api put-object --bucket $BUCKET --key $FILE --body $FILE --endpoint-url $S3_URL

SCRIPTS="banner_v2.0.sh function_v2.0.sh initscript_v2.0.sh"
for script in $SCRIPTS
do
  aws s3api get-object --bucket "$BUCKET" --key "$script" /root/"$script" --endpoint-url "$S3_URL" > /dev/null 2>&1
  chmod +x /root/"$script"
  echo "----- $script downloaded. -----"
done

for script in $SCRIPTS
do
  if ! [[ -f "$script" ]]; then
    echo "$script file dose not exist, exit vulnerability check process."
    exit 1
  else
    echo "$script file checked."
  fi
done

echo "
############################## Vulnerability check start ###############################
"

sleep 5

# Run Scripts
sudo /root/initscript_v2.0.sh