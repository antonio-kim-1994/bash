#!/bin/bash
# https://blog.naver.com/takudaddy/222220602092
# https://github.com/newbieh4cker/centos_vuln_check_script/blob/master/linux_vuln_check_script.sh

# Basic Info
export USER_NAME=""
export USER_PASSWORD=""
export COMPANY_NAME=""

# 0. 기본 서버 설정
# 0-1. check Execute Permission
if [ "$EUID" -ne 0 ]
	then echo "root 권한으로 스크립트를 실행하여 주십시오."
	exit 1
fi

# 0-2. CentOS 필수 파일 설치
if grep ^NAME /etc/os-release | grep -q CentOS; then
  sudo yum install -y epel-release util-linux > /dev/null 2>&1
fi

# 0-3. 사용자 추가 및 비밀번호 설정
if grep ^NAME /etc/os-release | grep -q Ubuntu; then
  sudo adduser --disabled-password --gecos "" "${USER_NAME}" > /dev/null 2>&1
  echo "${USER_NAME}:${USER_PASSWORD}" | sudo chpasswd > /dev/null 2>&1
  sudo usermod -s /bin/bash "${USER_NAME}" > /dev/null 2>&1
elif grep ^NAME /etc/os-release | grep -q CentOS; then
  sudo useradd "${USER_NAME}" > /dev/null 2>&1
  echo "${USER_PASSWORD}" | sudo passwd --stdin "${USER_NAME}" > /dev/null 2>&1
  sudo usermod -s /bin/bash "${USER_NAME}" > /dev/null 2>&1
fi

# 0-4. 사용자 권한 추가 (/etc/sudoers)
# sed -i '/<탐색구간>/a <치환구간>' <파일경로>
if ! grep -Eq "^${USER_NAME}\s*ALL=\(ALL\)\s*ALL" /etc/sudoers; then
  sed -i.bak "/^root\tALL/a ${USER_NAME}\tALL=(ALL)\tALL" /etc/sudoers
fi

# 0-5. sshd config banner 활성화
result=1 # 파일 수정이 있을 경우 : 0, 파일 수정이 없을 경우 : 1
FILE="/etc/ssh/sshd_config"

# 설정파일 백업
cp $FILE $FILE.bak

if grep -Eq "^PrintMotd no" $FILE; then
  sed -i.bak 's/^PrintMotd no/PrintMotd yes/' $FILE
  result=0
elif grep -Eq "^#PrintMotd (no|yes)" $FILE; then
  sed -i.bak -E 's/^#PrintMotd (no|yes)/PrintMotd yes/' $FILE
  result=0
fi

if [ $result -eq 0 ]; then
  sudo service sshd restart > /dev/null 2>&1
fi

# 0-6. Banner 설정
. /root/banner_v2.0.sh

banner
login_script

# 취얌점 진단 리스트 적용 스크립트 호출
. /root/function_v2.0.sh

Set_InitScript_Info

# ===== 취약점 진단 리스트 ===== #
SRV-001
SRV-004
SRV-011
SRV-012
SRV-013
SRV-014
SRV-026
SRV-027
SRV-028
SRV-069
SRV-074
SRV-087
SRV-096
SRV-108
SRV-109
SRV-122
SRV-127
SRV-131
SRV-133
SRV-163
SRV-164